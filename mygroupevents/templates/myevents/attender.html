{% extends "myevents/base.html" %}
{% load static %}
{% load place_extra %}
{% block title %} Welcome {% endblock %}
 
{% block extrastyle %}
 
{% endblock %}


{% block content%}
<!--hidden variables-->
<p id='ehash' style="display:none;">{{event.ehash}}</p>
<p id='uhash' style="display:none;">{{uhash}}</p> 
<div class="container">
 
<!--<div class="hero-unit"> -->
 	
 	<div class="row-fluid">  
 		<h2> Greetings   {{myname}}!</h2>
 		{%if isadmin  %}
 			<h3> Thanks for organizing the event <font color='#08c'> {{event.name}} </font> </h3>
		{%else%}
			<h3> You are invited to the event <font color='#08c'> {{event.name}} </font></h3>	
		{%endif%}
	</div> 
	<hr/>
	 
	 	<p>
	 		This event is
	 	  {%if event.detail%}
	 	  about <u> {{event.detail}} together </u> 
	 		{% endif %} 
	 		on <u>  {{event.eventDate}}  </u>
	 		{%if event.eventTime%}  
	 		<u> 	{{event.eventTime}}</u>
	 		{%endif%}	
	 	</p>
	 		<p>	with <u> {{event.inviter}}, {{event.friends}} </u> 	</p>
	 	  <p>	{% if event.location%} 
   			 near <u> {{event.location}} </u>
    		{%endif%}
	 	</p>
 
	{%if event.status ==  "2" %}
	<br/>
	<div class="row-fluid" id ="poll">
 		<h3> Let your friends know what you think about the following options. </h3>
 	<div class="row-fluid" id="candidates" >
		<table id="myTable" class="table table-bordered"> 
		<thead> 
		<tr> 
    	<!--<th>Option (name, location, rating, review count) </th> -->
	<th>Options</th>
    	<th>Vote</th>  
    	<th>Details</th> 
		</tr> 
		</thead> 
		<tbody>
		{% for choice in choices %}
		<tr> 
    		<td id="choice_id_{{choice.id}}"> 
    			{%if choice.url%}
    				<a target="_blank" href="{{choice.url}}" >
    				{{choice.name}} 
    				</a>
    			{%else%}
    				{{choice.name}}
    			{%endif%}
    		  
    		{% if choice.location %} 
    			<span class="badge">,   </span> {{choice.location}}
    		{%endif%} 
    		{%if choice.notes%}
    			<span class="badge">,  </span> {%if choice.image%}<img src="{{choice.image}}"> {%endif%} {{choice.notes}}
		{%endif%}
		</td> 
    		<td> 
   			 	<div class="btn-group" data-toggle="buttons-radio">
   			 		{% csrf_token %}
						<button value="{{choice.id}}"  class="btn btn-success like"> <i class="icon-search icon-thumbs-up"></i>  <span class="pos_vote_count" id="pos_vote_count_{{choice.id}}" value="{{choice.id}}"> {{posvotes|dictKey:choice.id}} </span> Like </button> 
						<button value="{{choice.id}}"  class="btn btn-danger dislike">	<i class="icon-search icon-thumbs-down"></i>  <span class="neg_vote_count" id="neg_vote_count_{{choice.id}}" value="{{choice.id}}">{{negvotes|dictKey:choice.id}}</span>  Dislike </button>				
				</div>
			</td> 
    		<td> 
    		<!--<button class="viewstats" value="{{choice.id}}"><i class="icon-search icon-eye-open"> </button> -->
    		<button value="{{choice.id}}"  class="btn btn-info viewstats"><i class="icon-search icon-eye-open"></i> View </button> 
    		
    		<div class="stats" id="stats_{{choice.id}}" value="{{choice.id}}">  </div>
    		</td> 
		</tr> 
		{% endfor %}
		</tbody> 
	</table> 
 </div>
 
 </div> <!--end of poll--> 
 
	 <!----============add comments================-->  		 
	 <div class="accordion" id="comments_accordion">
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#comments_accordion" href="#comments"  id="getcomments">
                  <span class="add-on"><i class="icon-comment"></i></span> Shout out your comments
                </a>
              </div>
              <div id="comments" class="accordion-body collapse in">
                <div class="accordion-inner">
                   <div id='flash'></div>
							<ul id="show_comment_list" class="nav nav-pills nav-stacked">
							</ul>
 							<form class="well form-search" action="/myevents/{{event.ehash}}/{{uhash}}/writeComment/" method="post">
 								{%csrf_token%}
							  <span class="help-inline">{{myname}} says: </span>  
							  <input id="acomment" type="text" name="acomment" />
								<button type="submit" class="btn" id="submitComment">OK</button>
						</form>
                </div>
              </div>
            </div>
            </div>		<!-- end of comment accordion -->
 			<!--
 						<div class="accordion" id="comments_accordion">
 				<div class="accordion-heading"> 
					<a class="accordion-toggle" data-toggle="collapse" data-parent="#comments_accordion" href="#comments" id="getcomments">
       		<span class="add-on"><i class="icon-comment"></i></span> Shout out your comments
      		</a> 
      	</div>
 			
 				<div class="row-fluid" id="comments" class="accordion-body collapse in" >
 						<div class="accordion-inner">
							<div id='flash'></div>
							<ul id="show_comment_list" class="nav nav-pills nav-stacked">
							</ul>
 							<form class="well form-search" action="/myevents/{{event.ehash}}/{{uhash}}/writeComment/" method="post">
 								{%csrf_token%}
							  <span class="help-inline">{{myname}} says: </span>  
							  <input id="acomment" type="text" name="acomment" />
								<button type="submit" class="btn" id="submitComment">OK</button>
						</form>
 					</div>
 				</div>  -->
 	
	<br>
	<!-- terminate the event ================================================== -->
 	<div class="row-fluid" id="foradmin">

 			{%if isadmin  %}
 				<div class="row-fluid">
 			 		<!-- <a class="confirmTermination"  href="/myevents/{{event.ehash}}/{{uhash}}/terminateEvent">Make Decision and Close the Voting?</a> -->
 			 		<a class="confirm">Make a final decision and close the vote.</a> 
 				</div>
 				<div id="foo"><div>
 				<div class="row-fluid">
 						<div class="alert alert-success" id="terminationEmail" style="display:none;">
 							<p class="emailMSG"> Ladies and Gentlemen,</h2> 
 							<p class="emailMSG"> Thanks for your participation. 
 							We have made our decision for the event {{event.name}}.</p>  
  						<p class="emailMSG"> We have agreed on <input type="text" id="finalChoice"/> </p>
			  				{%csrf_token%}
			  			<button class="btn btn-primary emailMSG" id="sendoutFinalResult" data-loading-text="sending emails..."><i class="icon-search icon-envelope"></i> SEND EMAIL </button> 			 			
			 			</div>
 				</div>
 				<div class="row-fluid" id="finalMessage">
 						
 				</div>
 			{%endif%}

 		{%else%}
 					<div class="row-fluid">
 						<div class="alert alert-success" 
 							<p> The event is closed at {{event.closeDate}} </p>
 							<p>	The final choice is {{event.finalChoice}}</p>
 						</div>
 					</div>
		{%endif%}
	</div> 
	
	<br>
	<br>
	<!-- Footer
================================================== -->
<footer class="footer ftwraper">
<!--<p class="pull-right"><a href="#">Back to top</a></p> -->
     <p>Designed and built by <a href="http://paloalto.thlab.net/research/recommendations">The Group!</a></p>
</footer>
</div> <!--end of container-->
  

{% endblock %}
{% block morescript %}
	<script type="text/javascript" src=" {%static "js/bootstrap-popover.js"%}"></script> 
	<script type="text/javascript" src=" {%static "js/bootstrap-tooltip.js"%}"></script> 
	<script type="text/javascript" src=" {%static "js/bootstrap-button.js"%}"></script> 
	<script type="text/javascript" src=" {%static "js/bootstrap-transition.js"%}"></script>
	<script type="text/javascript" src=" {%static "js/bootstrap-modal.js"%}"></script> 
	<script type="text/javascript" src=" {%static "js/jquery.bootstrap.confirm.popover.js"%}"></script> 
	<script type="text/javascript" src=" {%static "js/bootbox.js"%}"></script> 
	<script type="text/javascript" src=" {%static "js/spin.js"%}"></script> 
	<script>
		$(function() {
			//var url = "myEvents/"+ ehash+"/"+uhash+"/xhr_test/"
			var url = "../xhr_test/"
			//console.debug(url);
			$.get(url, function(data) {
        		//console.debug(data);
        		$('#ajax_test').html(data);
   			});
		});
		
		jQuery.fn.get_pos_votes = function() {
			var id=$(this).attr("value");
			//console.debug(id)
			var dataString = 'choice_id='+ id;
			$.ajax
				({
				type: "GET",
				url:  "../getPosVote/",
				data: dataString,
				cache: false,
				success: function(data)
				{
				//console.debug("pos vote="+data.cnt)
				$('#pos_vote_count_'+id).html(data.cnt);
				//$(this).html(data.cnt);
				} });
		};
		
		jQuery.fn.get_neg_votes = function() {
			var id=$(this).attr("value");
			//console.debug(id)
			var dataString = {'choice_id': id};
			$.ajax
			({
				type: "GET",
				url:  "../getNegVote/",
				data: dataString,
				cache: false,
				success: function(data)
				{
				//console.debug("neg_vote="+data.cnt)
				$('#neg_vote_count_'+id).html(data.cnt);
				//$(this).html(data.cnt);
				} 
			});
		};
		
		jQuery.fn.set_vote = function(vote) {
			var id=$(this).attr("value");
			//console.debug("id="+id);
			var dataString = {'choice_id': id,'vote':vote,csrfmiddlewaretoken:'{{csrf_token}}'}
			//console.debug(vote);
			$.ajax
			({
				type: "POST",
				url:  "../setVote/",
				data: dataString,
				cache: false,
				success: function(data)
				{    
					//console.debug(data);
					$('#pos_vote_count_'+id).get_pos_votes();
					$('#neg_vote_count_'+id).get_neg_votes();
				}
			});
		};
				
		$(document).ready(function(){
			$(".like").click(function()
			{
				$(this).set_vote(1);
			});
		});
		$(document).ready(function(){
			$(".dislike").click(function()
			{
				$(this).set_vote(-1);
			});
		});		
		
		jQuery.fn.show_my_votes = function(data) {
			var result = jQuery.parseJSON(data);
      			//console.debug("I like: "+result.likes);
        		//console.debug("I dislike: "+result.dislikes);
        		var ilike = result.likes
        		var idislike = result.dislikes
        		if(ilike !="")
        			$("#ilike").html("<p>I LIKE : "+ilike +"</p>");
        		if (idislike !="")
        			$("#idislike").html("<p> I DISLIKE : "+idislike+"</p>");
		};
 
		$(document).ready(function(){
		$(".close").live("click",function(){
    		 var id=$(this).attr("value");
    		 //console.debug("id is: "+id)
    		 $("#stats_"+id).slideUp("fast");
		});
	});

	$(document).ready(function(){
		$(".viewstats").live("click",function(event){
			event.preventDefault();      
			var id=$(this).attr("value");
			//console.debug("choice_id =  "+id)
			var dataString = {"choice_id": id};
			
			$("#stats_"+id).slideDown("fast").html("Loading....");
			$.ajax
			({
				type: "GET",
				url:  "../getVoteStats/",
				data: dataString,
				cache: false,
				success: function(response)
				{
					var like = response.likes
					var dislike = response.dislikes;
	
					var output =  '<div class="stat-details"><a class="close" data-dismiss="stat-details" value="'+id+'">×</a><b>Rating for this item</b><table border="0" width="100%"><tr><td> Liked by  </td><td>'+ like+'</td> </tr><tr><td> Disliked by</td> <td>'+dislike+'</td></tr></table>'
					//console.debug(output)
					
					$("#stats_"+id).html(output);
				} 
			 
			});
			//$(this).next(".stats").slideToggle(600);

		});
  	});
			
			
	$(document).ready(function() {
		$.ajaxSetup({ cache: false }); // This part addresses an IE bug.  without it, IE will only load the first number and will never refresh
			setInterval(function() {
				$('#resultmessage').load('../currentResult/',function(data) {
					var res  =jQuery.parseJSON(data)
  					var place = res.place;
  					var likes = parseInt(res.numlikes);
  					var dislikes = parseInt(res.numdislikes);
  					//console.debug(place,likes,dislikes);
  					if (likes>0)
  					{
  						var msg = "<p> Currently, We are going to " +place+ " because " + likes+ " people liked it </p>"
  						if (dislikes>0)
							msg += "<p>However, "+dislikes+" people disliked it </p>"
						$('#resultmessage').html(msg)
  					}
  					else{
  						var msg = "<p> Currently, We don't know where to go"  
  						if (dislikes>0)
  							msg += "<p>However,"+dislikes+" people don't like "+place+"</p>"
  						$('#resultmessage').html(msg)
  					}
  			})}, 30000); // the "3000" here refers to the time to refresh the div.  it is in milliseconds.
	});
			
			$(document).ready(function() {
				$.ajaxSetup({ cache: false }); // This part addresses an IE bug.  without it, IE will only load the first number and will never refresh
				setInterval(function() {
			// why .get doesn't work, but load works?
			// the problem for load is that it will display the result directly to html
				$("#getmyvotes").load("../getMyVotes/", function(data) {
       				$(this).show_my_votes(data);
   				})},100000);
		});
		
	$(document).ready(function(){
          $("a.confirm").click(function(e) {
                e.preventDefault();
               // bootbox.confirm("Are you sure?", function(confirmed) {
               //    console.log("Confirmed: "+confirmed);
               var confirmed = true
               if (confirmed)
               {
                    $.ajax
		 ({
			 type: "GET",
			 url:  "../getResult/",
			 data: {},
			 cache: false,
			success: function(data)
			 {
  				var place = data.place;
  				var likes = parseInt(data.numlikes);
  				var dislikes = parseInt(data.numdislikes);
  							//console.debug(place,likes,dislikes);
  				$('#finalChoice').removeAttr('disabled');
				$('#finalChoice').val(place);				 
  				$('#terminationEmail').css('display','block');
			} 
		}); 	 	
                }
               //});
            });
		 });
		 
		function startspin(){
			var opts = {
  			lines: 13, // The number of lines to draw
  			length: 25, // The length of each line
  			width: 16, // The line thickness
  			radius: 20, // The radius of the inner circle
  			rotate: 30, // The rotation offset
  			color: '#000', // #rgb or #rrggbb
  			speed: 1.2, // Rounds per second
  			trail: 66, // Afterglow percentage
  			shadow: false, // Whether to render a shadow
  			hwaccel: false, // Whether to use hardware acceleration
  			className: 'spinner', // The CSS class to assign to the spinner
  			zIndex: 2e9, // The z-index (defaults to 2000000000)
  			top: 'auto', // Top position relative to parent in px
  			left: 'auto' // Left position relative to parent in px
			};
			var target = document.getElementById('foo');
			var spinner = new Spinner(opts).spin(target);
			return spinner;
		}
		 
		 $(document).ready(function(){
		 	$("#sendoutFinalResult").click(function() {
		 		var finalchoice = $('#finalChoice').val()
		 //		console.debug(finalchoice)		 		
		 		bootbox.confirm("Are you sure?", function(confirmed) {
       		 	console.log("Confirmed: "+confirmed);
        		if (confirmed)
       			{
					spin=startspin();
		 			$.ajax
					({
					type: "POST",
					url:  "../terminateEvent/",
					data:  {"finalChoice": finalchoice,csrfmiddlewaretoken:'{{csrf_token}}'},
					cache: false,
					success: function(data)
					{    	 	 
						spin.stop();
						// disable all input button.
						$('.input').attr('disabled','disabled');
				 		$('#finalMessage').html('<div class="alert alert-error"><p>An email with final decision has been sent to your friends, Enjoy!</p></div>') 
				 		//$('#finalChoice').attr('disabled', 'disabled');
				 		//$('#poll').hide();
						//disable all buttons
						$('.like').attr('disabled', true);
						$('.dislike').attr('disabled', true);
					}
					});
				}
				
		 	});
		 	});
		 });
		 
		 $(document).ready(function(){
     			$.ajax({
				type: "GET",
				url:  "../getAllComments/",
				data:  {},
				cache: false,
				success: function(data)
				{    	 	
				// chrome doesn't take for each... 
				//for each(var comm in data){
					for (var c in data){
						var comm = data[c];
						//console.debug(comm);
						var html = '<li><blockquote><p>'+ comm.say + ' </p><small>  '+ comm.name + ' at ' + comm.date +'</small></blockquote></li>';
				 		$('#show_comment_list').append(html); 
				 	}
				}
				});
    	});
    	
		 	
		 	$(document).ready(function(){
		 		$("#submitComment").click(function() {
		 				var acomment = $("#acomment").val();
						if(acomment=='')
						{
							alert('Please Say Something');
						}
						else
						{
							$("#flash").show();
							$("#flash").fadeIn(400).html('Loading Comment...');
							$.ajax({
									type: "POST",
									url: "../writeComment/",
									data: {'acomment':acomment,csrfmiddlewaretoken:'{{csrf_token}}'},
									cache: false,
									success: function(response){
										var html = ' <li><blockquote><p>'+ response.say + ' </p><small>  '+ response.name + ' at ' + response.date +'</small></blockquote></li>';
				 						$('ul#show_comment_list').append(html);  
										$("ul#show_comment_list li:last").fadeIn("slow");
										$("#flash").hide();
										//clear the input text box
										$("#acomment").val("");
									}
							});
						}return false;
		 		});
		 	});
</script>
{% endblock%}
